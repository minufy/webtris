const I_OFFSETS = {
    "01": [[1, 0], [-2, 0], [-2, 1], [1, -2]],
    "10": [[-1, 0], [2, 0], [-1, 2], [2, -1]],
    "12": [[-1, 0], [2, 0], [-1, -2], [2, 1]],
    "21": [[-2, 0], [1, 0], [-2, -1], [1, 2]],
    "23": [[2, 0], [-1, 0], [2, -1], [-1, 2]],
    "32": [[1, 0], [-2, 0], [1, -2], [-2, 1]],
    "30": [[1, 0], [-2, 0], [1, 2], [-2, -1]],
    "03": [[-1, 0], [2, 0], [2, 1], [-1, -2]],
    "02": [[0, -1]],
    "13": [[1, 0]],
    "20": [[0, 1]],
    "31": [[-1, 0]],
};

const JLTSZ_OFFSETS = {
    "01": [[-1, 0], [-1, -1], [0, 2], [-1, 2]],
    "10": [[1, 0], [1, 1], [0, -2], [1, -2]],
    "12": [[1, 0], [1, 1], [0, -2], [1, -2]],
    "21": [[-1, 0], [-1, -1], [0, 2], [-1, 2]],
    "23": [[1, 0], [1, -1], [0, 2], [1, 2]],
    "32": [[-1, 0], [-1, 1], [0, -2], [-1, -2]],
    "30": [[-1, 0], [-1, 1], [0, -2], [-1, -2]],
    "03": [[1, 0], [1, -1], [0, 2], [1, 2]],
    "02": [[0, -1], [1, -1], [-1, -1], [1, 0], [-1, 0]],
    "13": [[1, 0], [1, -2], [1, -1], [0, -2], [0, -1]],
    "20": [[0, 1], [-1, 1], [1, 1], [-1, 0], [1, 0]],
    "31": [[-1, 0], [-1, -2], [-1, -1], [0, -2], [0, -1]],
};

const MINO_TYPES = ["Z", "L", "O", "S", "I", "J", "T"];
const MINO_COLORS = {
    "I": "#42AFE1",
    "J": "#1165B5",
    "L": "#F38927",
    "O": "#F6D03C",
    "S": "#51B84D",
    "T": "#B94BC6",
    "Z": "#EB4F65",
    "X": "#555555",
    "H": "#444444",
};
const MINO_SHAPES = {
    "I": {
        "0": [
            [0, 0, 0, 0],
            [1, 1, 1, 1],
            [0, 0, 0, 0],
            [0, 0, 0, 0],
        ],
        "1": [
            [0, 0, 1, 0],
            [0, 0, 1, 0],
            [0, 0, 1, 0],
            [0, 0, 1, 0],
        ],
        "2": [
            [0, 0, 0, 0],
            [0, 0, 0, 0],
            [1, 1, 1, 1],
            [0, 0, 0, 0],
        ],
        "3": [
            [0, 1, 0, 0],
            [0, 1, 0, 0],
            [0, 1, 0, 0],
            [0, 1, 0, 0],
        ],
    },
    "O": {
        "0": [
            [0, 1, 1, 0],
            [0, 1, 1, 0],
        ],
        "1": [
            [0, 1, 1, 0],
            [0, 1, 1, 0],
        ],
        "2": [
            [0, 1, 1, 0],
            [0, 1, 1, 0],
        ],
        "3": [
            [0, 1, 1, 0],
            [0, 1, 1, 0],
        ],
    },
    "T": {
        "0": [
            [0, 1, 0],
            [1, 1, 1],
            [0, 0, 0],
        ],
        "1": [
            [0, 1, 0],
            [0, 1, 1],
            [0, 1, 0],
        ],
        "2": [
            [0, 0, 0],
            [1, 1, 1],
            [0, 1, 0],
        ],
        "3": [
            [0, 1, 0],
            [1, 1, 0],
            [0, 1, 0],
        ],
    },
    "S": {
        "0": [
            [0, 1, 1],
            [1, 1, 0],
            [0, 0, 0],
        ],
        "1": [
            [0, 1, 0],
            [0, 1, 1],
            [0, 0, 1],
        ],
        "2": [
            [0, 0, 0],
            [0, 1, 1],
            [1, 1, 0],
        ],
        "3": [
            [1, 0, 0],
            [1, 1, 0],
            [0, 1, 0],
        ],
    },
    "Z": {
        "0": [
            [1, 1, 0],
            [0, 1, 1],
            [0, 0, 0],
        ],
        "1": [
            [0, 0, 1],
            [0, 1, 1],
            [0, 1, 0],
        ],
        "2": [
            [0, 0, 0],
            [1, 1, 0],
            [0, 1, 1],
        ],
        "3": [
            [0, 1, 0],
            [1, 1, 0],
            [1, 0, 0],
        ],
    },
    "J": {
        "0": [
            [1, 0, 0],
            [1, 1, 1],
            [0, 0, 0],
        ],
        "1": [
            [0, 1, 1],
            [0, 1, 0],
            [0, 1, 0],
        ],
        "2": [
            [0, 0, 0],
            [1, 1, 1],
            [0, 0, 1],
        ],
        "3": [
            [0, 1, 0],
            [0, 1, 0],
            [1, 1, 0],
        ],
    },
    "L": {
        "0": [
            [0, 0, 1],
            [1, 1, 1],
            [0, 0, 0],
        ],
        "1": [
            [0, 1, 0],
            [0, 1, 0],
            [0, 1, 1],
        ],
        "2": [
            [0, 0, 0],
            [1, 1, 1],
            [1, 0, 0],
        ],
        "3": [
            [1, 1, 0],
            [0, 1, 0],
            [0, 1, 0],
        ],
    },
};

class Mino{
    constructor(type, x, y, r=0){
        this.type = type;
        this.x = Math.floor(x);
        this.y = Math.floor(y);
        this.r = r;
    }

    checkCollison(board){ 
        const minoShape = MINO_SHAPES[this.type][this.r];
        for (let y=0; y<minoShape.length; y++){
            for (let x=0; x<minoShape[0].length; x++){
                if (minoShape[y][x] == 1){
                    const tx = this.x+x
                    const ty = this.y+y
                    if (board.h > ty && ty >= 0 && board.w > tx && tx >= 0){
                        if (board.grid[ty][tx] != " "){
                            return true;
                        }
                    }
                    else{
                        return true;
                    }
                }
            }
        }
        return false;
    }

    testOffsets(board, offsets){
        for (let i=0; i<offsets.length; i++){
            if (this.move(offsets[i][0], offsets[i][1], board))
                return true;
        }
        return false;
    }

    rotate(dr, board){
        if (this.type == "O")
            return;
        const rOld = this.r;
        this.r += dr;
        if (this.r >= 4)
            this.r -= 4;
        if (this.r < 0)
            this.r += 4;
        if (this.checkCollison(board)){
            const key = `${rOld}${this.r}`;
            let offsets = JLTSZ_OFFSETS[key];
            if (this.type == "I")
                offsets = I_OFFSETS[key];
            if (!this.testOffsets(board, offsets)){
                this.r = rOld;
            }
        }
    }

    move(x, y, board){
        this.x += x;
        this.y += y;
        if (this.checkCollison(board)){
            this.x -= x;
            this.y -= y;
            return false;
        }
        return true;
    }
}

export { MINO_COLORS, MINO_SHAPES, MINO_TYPES, Mino };